{% extends 'tom_common/base.html' %}
{% load comments bootstrap4 tom_common_extras targets_extras observation_extras dataproduct_extras static cache classification_extras tides_targets_extras myplots_tags %}
{% block title %}Target {{ object.name }}{% endblock %}
{% block additional_css %}
<link rel="stylesheet" href="{% static 'tom_targets/css/main.css' %}">
{% endblock %}
{% block content %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Function to update the URL with the selected tab.
    const updateUrlWithTab = (tabId) => {
        const url = new URL(window.location.href);
        url.searchParams.set('tab', tabId);
        history.replaceState({}, document.title, url.toString());
    };

    // Tab change event listener.
    document.querySelectorAll('#tabs .nav-link').forEach(tab => {
        tab.addEventListener('click', () => updateUrlWithTab(tab.id.replace('-tab', '')));
    });

    // Select initial tab based on the URL.
    const tabQuery = new URL(window.location.href).searchParams.get('tab');
    if (tabQuery) {
        document.querySelector(`a[href="#${tabQuery}"]`)?.click();
    }

    // Main spectroscopy plot
    const plotDiv = document.querySelector("#spectroscopyPlot .js-plotly-plot");

    // Redshift handling and plot updates.
    const redshiftSlider = document.querySelector("#redshiftSlider");
    const redshiftInput = document.querySelector("#redshiftInput");

    // Velocity handling and plot updates.
    const velocitySlider = document.querySelector("#velocitySlider");
    const velocityInput = document.querySelector("#velocityInput");

    let lines = {};  // placeholder

fetch("{% static 'json/line_data.json' %}")
	.then(response => response.json())
	.then(data => {
		lines = data;

		// Separate containers
		const emissionContainer = document.getElementById("emission-lines");
		const absorptionContainer = document.getElementById("absorption-lines");
		const highEnergyContainer = document.getElementById("high-energy-lines");

		// Build checkboxes dynamically from the .json file
		Object.entries(lines).forEach(([id, { color, label, type }]) => {
			const wrapper = document.createElement("label");
			wrapper.innerHTML = `
				<input type="checkbox" id="${id}">
				<span style="color:${color};">${label}</span>
			`;

			if (type === "emission") {
				emissionContainer.appendChild(wrapper);
			} else if (type === "absorption") {
				absorptionContainer.appendChild(wrapper);
			} else if (type === "high-energy") {
				highEnergyContainer.appendChild(wrapper);
			}
		});

		// Add event listeners after building checkboxes
		Object.keys(lines).forEach(id => {
			const checkbox = document.getElementById(id);
			if (checkbox) {
				checkbox.addEventListener("change", updateRedshiftVelocity);
			}
		});
	})
	.catch(error => console.error("Error loading line data:", error));

    function updateLines(z, v) {
        const newShapes = Object.entries(lines)
            .filter(([id]) => document.getElementById(id)?.checked)
            .flatMap(([_, { x, color }]) => x.map(value => ({
                type: "line",
                x0: value * ( (1 + z) + (v/299792.458)),
                x1: value * ( (1 + z) + (v/299792.458)),
                y0: 0,
                y1: 1,
                xref: "x",
                yref: "paper",
                line: { color, width: 1},
                layer: "below"
            })));
        Plotly.relayout(plotDiv, { shapes: newShapes });
    }

    function updateRedshiftVelocity() {
        // Always pull from the current slider values (force numbers)
        const z = Number(redshiftSlider.value);
        const v = Number(velocitySlider.value);

        // Update paired inputs
        redshiftInput.value = isFinite(z) ? z.toFixed(4) : "";
        velocityInput.value = isFinite(v) ? v.toFixed(0) : "";

        // Only call updateLines if both are valid
        if (!isNaN(z) && z >= 0 && z <= 5 && !isNaN(v) && v >= -50000 && v <= 50000) {
            updateLines(z, v);
        }
    }

    // Attach event listeners.
    redshiftSlider.addEventListener("input", updateRedshiftVelocity);
    velocitySlider.addEventListener("input", updateRedshiftVelocity);

    // --- Manual text inputs (push back into sliders) ---
    redshiftInput.addEventListener("change", () => {
        const z = Number(redshiftInput.value);
        if (!isNaN(z)) {
            redshiftSlider.value = z;
            updateRedshiftVelocity();
        }
    });
    velocityInput.addEventListener("change", () => {
        const v = Number(velocityInput.value);
        if (!isNaN(v)) {
            velocitySlider.value = v;
            updateRedshiftVelocity();
        }
    });

    Object.keys(lines).forEach(id => {
        document.getElementById(id)?.addEventListener("change", updateRedshiftVelocity);
    });

    // --- Binned-spectrum overlay ---

    const BINNED_LABEL_PREFIX = 'Bin';

    function getFigDiv() {
      return document.querySelector("#spectroscopy .js-plotly-plot")
          || document.querySelector("#spectroscopyPlot .js-plotly-plot");
    }

    function getRawSpectrum() {
      const fig = getFigDiv();
      if (!fig || !fig.data || !fig.data.length) return null;
      let i = fig.data.findIndex(t => Array.isArray(t?.x) && Array.isArray(t?.y));
      if (i < 0) i = 0;
      const x = fig.data[i].x, y = fig.data[i].y;
      if (!Array.isArray(x) || !Array.isArray(y) || x.length !== y.length || x.length === 0) return null;
      return { x, y };
    }

    function binByDeltaLambdaIndex(w, f, dlam){
      if (!(dlam > 0) || !w || !w.length) return {x:[], y:[]};

      const X = [], Y = [];
      for (let i=0;i<w.length;i++){
        const xi = Number(w[i]), yi = Number(f[i]);
        if (Number.isFinite(xi) && Number.isFinite(yi)) { X.push(xi); Y.push(yi); }
      }
      if (!X.length) return {x:[], y:[]};

      const minW = Math.min(...X), maxW = Math.max(...X);
      const nBins = Math.max(1, Math.ceil((maxW - minW) / dlam));
      const sum = new Array(nBins).fill(0);
      const cnt = new Array(nBins).fill(0);

      const inv = 1/dlam, eps = 1e-9;
      for (let i=0;i<X.length;i++){
        let idx = Math.floor((X[i] - minW) * inv + eps);
        if (idx < 0) idx = 0;
        if (idx >= nBins) idx = nBins - 1; // clamp right edge
        sum[idx] += Y[i];
        cnt[idx] += 1;
      }

      const bx = [], by = [];
      for (let b=0;b<nBins;b++){
        if (cnt[b] > 0){
          const left = minW + b*dlam;
          const right = left + dlam;
          bx.push(0.5*(left + right));
          by.push(sum[b] / cnt[b]);
        }
      }
      return { x: bx, y: by };
    }

    function makeBinnedTrace() {
      const raw = getRawSpectrum();
      if (!raw) return null;

      const dlam = Number(document.getElementById('bin-size').value);
      const res = binByDeltaLambdaIndex(raw.x, raw.y, dlam);

      return {
        name: `Bin (${dlam} Å)`,
        x: res.x, y: res.y,
        mode: "lines",
        line: { width: 2 },
        showlegend: false,
        hovertemplate: "λ=%{x:.1f} Å<br>F (binned) = %{y}<extra></extra>"
      };
    }

    function ensureLegendOff(fig){
      Plotly.relayout(fig, { showlegend: false });
      const idx = (fig.data || []).findIndex(t => t.name && t.name.startsWith(BINNED_LABEL_PREFIX));
      if (idx >= 0) Plotly.restyle(fig, { showlegend: [false] }, [idx]);
    }

    function refreshBinned(){
      const fig = getFigDiv();
      if (!fig) return;
      const toggle = document.getElementById('toggle-binned');
      const existingIndex = (fig.data || []).findIndex(t => t.name && t.name.startsWith(BINNED_LABEL_PREFIX));

      if (!toggle.checked) {
        if (existingIndex >= 0) Plotly.deleteTraces(fig, [existingIndex]);
        //ensureLegendOff(fig);
        return;
      }
      const trace = makeBinnedTrace();
      if (!trace) return;

      if (existingIndex >= 0) {
        Plotly.restyle(fig, {x:[trace.x], y:[trace.y], name:[trace.name], line:[trace.line], showlegend:[false]}, [existingIndex]);
      } else {
        Plotly.addTraces(fig, [trace]);
      }
      //ensureLegendOff(fig);
    }

    ['toggle-binned','bin-size'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', refreshBinned);
    });

    (function ensureReady(){
      const tryInit = () => {
        const fig = getFigDiv();
        if (fig && fig.data && fig.data.length) { refreshBinned(); return true; }
        return false;
      };
      if (!tryInit()){
        const iv = setInterval(() => { if (tryInit()) clearInterval(iv); }, 200);
        setTimeout(() => clearInterval(iv), 8000);
      }
    })();

    document.querySelectorAll('#tabs .nav-link').forEach(tab => {
      tab.addEventListener('click', () => {
        setTimeout(() => {
          if (document.getElementById("spectroscopy-tab").classList.contains("active")) refreshBinned();
        }, 60);
      });
    });

    // Show/hide spectroscopy elements based on active tab.
    const toggleSpectroscopyElements = () => {
        const isActive = document.getElementById("spectroscopy-tab").classList.contains("active");
        document.querySelectorAll(".spectroscopy-only").forEach(el => {
          if (isActive) {
            el.classList.remove('d-none');
          } else {
            el.classList.add('d-none');
          }
      });
    };
    document.querySelectorAll(".nav-link").forEach(tab => {
        tab.addEventListener("click", () => setTimeout(toggleSpectroscopyElements, 50));
    });

    toggleSpectroscopyElements();  // Run once on page load
});
</script>

<div class="row">
  <div class="col-md-3">
    <div id="target-info">
      {% target_feature object %}
      {% if object.future_observations %}
      <div class="alert alert-success">
        {{ object.future_observations|length }} upcoming observation{{ object.future_observations|pluralize }}
      </div>
      {% endif %}
      {% target_unknown_statuses object %}
      {% target_buttons object %}
      {% tides_target_data object %}
      <h3>Classifications</h3>
      <ul>
        <li><strong>Auto Classification:</strong></li>
        {% if object.auto_tidesclass %}
          {{ object.auto_tidesclass }}
          {% if object.auto_tidesclass_subclass %}
            <ul>
              <li>{{ object.auto_tidesclass_subclass.sub_class }}</li>
            </ul>
          {% endif %}
          {% if object.auto_tidesclass_prob %}
            <p>Probability: {{ object.auto_tidesclass_prob }}</p>
          {% endif %}
        {% else %}
          <p>No Auto Classification</p>
        {% endif %}
      </ul>
      
      <ul>
        <li><strong>Human Classification:</strong></li>
        {% if aggregated_human_class %}
            <p><strong>Most Common Classification:</strong> {{ aggregated_human_class.most_common_class }}</p>
            <p><strong>Number of Submissions:</strong> {{ aggregated_human_class.total_submissions }}</p>
            <p><strong>Count of Most Common Classification:</strong> {{ aggregated_human_class.count }}</p>
        {% else %}
            <p>No human classifications submitted yet.</p>
        {% endif %}
      </ul>
      <ul>
        <li><strong>All Human Classifications</strong></li>
        {% if human_classifications %}
            <ul>
                {% for submission in human_classifications %}
                    <li>
                        <strong>{{ submission.user.username }}</strong> submitted 
                        <strong>{{ submission.tidesclass }}</strong> 
                        {% if submission.tidesclass_other %}(Other: {{ submission.tidesclass_other }}){% endif %}
                        {% if submission.tidesclass_subclass %}(Subclass: {{ submission.tidesclass_subclass.name }}){% endif %}
                        on {{ submission.timestamp|date:"Y-m-d H:i" }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No classifications have been submitted yet.</p>
        {% endif %}
      </ul>
      {% classification_form target.id %}
      {% recent_photometry object limit=3 %}
      {# {% endif %} #}
      {# {% recent_photometry object num_points=3 %} #}

    </div>
  </div>
  <div class="col-md-8">
    <ul class="nav nav-tabs" role="tablist" id="tabs">
      <li class="nav-item">
        <a class="nav-link active" id="spectroscopy-tab" href="#spectroscopy" role="tab" data-toggle="tab">Spectroscopy</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="photometry-tab" href="#photometry" role="tab" data-toggle="tab">Photometry</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="observe-tab" href="#observe" role="tab" data-toggle="tab">Observe</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="observations-tab" href="#observations" role="tab" data-toggle="tab">Observations</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="manage-data-tab" href="#manage-data" role="tab" data-toggle="tab">Manage Data</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="manage-groups-tab" href="#manage-groups" role="tab" data-toggle="tab">Manage Groups</a>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane" id="observe">
        <h4>Observe</h4>
        {% observing_buttons object %}
        <hr/>
        {% observationtemplate_run object %}
        <hr/>
        <h4>Plan</h4>
        {% if object.type == 'SIDEREAL' %}
          {% target_plan %}
          {% moon_distance object %}
        {% elif target.type == 'NON_SIDEREAL' %}
          <p>Airmass plotting for non-sidereal targets is not currently supported. If you would like to add this functionality, please check out the <a href="https://github.com/TOMToolkit/tom_nonsidereal_airmass" target="_blank">non-sidereal airmass plugin.</a></p>
        {% endif %}
      </div>
      <div class="tab-pane" id="observations">
        {% existing_observation_form object %}
        <h4>Observations</h4>
        <a href="{% url 'targets:detail' pk=target.id %}?update_status=True" title="Update status of observations for target" class="btn btn-primary">Update Observations Status</a>
        {% observation_list object %}
      </div>
      <div class="tab-pane" id="manage-data">
        {% if user.is_authenticated %}
          {% upload_dataproduct object %}
        {% endif %}
        {% if user.is_authenticated %}
        <hr>
        {% query_single_target_data_service object %}
        <hr>
        {% endif %}
        {% dataproduct_list_for_target object %}
      </div>
      <div class="tab-pane" id="manage-groups">
        {% target_groups target %}
      </div>
      <div class="tab-pane" id="photometry">
        {% target_photometry target %}
        {% get_photometry_data object %}
        </div>
      <div class="tab-pane active" id="spectroscopy">
        {% target_spectroscopy target %}

        <!-- Bin/Overplot controls -->
        <div class="d-flex align-items-center gap-2 mb-4 spectroscopy-only">
          <input class="form-check-input" type="checkbox" id="toggle-binned">
          <label class="form-check-label me-3" for="toggle-binned">Bin (Å): </label>
          <input id="bin-size" class="form-control form-control-sm me-2" style="width:8rem"
            type="number" min="5" step="10" value="15">
        </div>
        <!-- Bin/Overplot controls -->

      </div>
      <!-- Checkboxes -->
      <div class="checkbox-container spectroscopy-only">

          <div class="checkbox-group">
              <h5>Emission Lines</h5>
              <div class="checkbox-grid" id="emission-lines"></div>
          </div>

          <div class="checkbox-group">
              <h5>Absorption Lines</h5>
              <div class="checkbox-grid" id="absorption-lines"></div>
          </div>

          <div class="checkbox-group">
              <h5>High Energy Lines</h5>
              <div class="checkbox-grid" id="high-energy-lines"></div>
          </div>

    </div>
      
      {% comments_enabled as comments_are_enabled %}
      <hr/>
      <h5>Comments</h5>
        {% if comments_are_enabled %}
          {% render_comment_list for object %}
          {% url 'targets:detail' object.id as next %}
          {% if user.is_authenticated %}
            {% render_comment_form for object %}
          {% endif %}
        {% endif %}
    </div>
  </div>
  <div class="col-md-1">
    {% if object.type == 'SIDEREAL' %}
    {% aladin_finderchart object %}
    {% endif %}
    <!-- Redshift Slider -->
    <div class="spectroscopy-only">
      <label for="redshiftSlider" style="display:block; width:250px;">
          Redshift (z):
      </label>
      <input type="range" id="redshiftSlider" min="0" max="5" step="0.0001" value="0">
      <input type="number" id="redshiftInput" min="0" max="5" step="0.0001" value="0" style="width: 80px; text-align: center;">
    </div>
      <!-- Velocity Slider -->
    <div class="spectroscopy-only">
        <label for="velocitySlider" style="display:block; width:250px;">
          Additional line velocity (km\s):
        </label>
      <input type="range" id="velocitySlider" min="-50000" max="50000" step="100" value="0">
      <input type="number" id="velocityInput" min="-50000" max="50000" step="100" value="0" style="width: 80px; text-align: center;">
    </div>
  </div>
</div>
{% endblock %}
